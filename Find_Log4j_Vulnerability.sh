#!/bin/bash

NONE='\033[00m'
RED='\033[01;31m'
GREEN='\033[01;32m'

dt=`date +%d%m%Y-%H%M%S`
tempfile="/tmp/tempreadfile_log4j_${dt}.txt"
tempfile_jar="/tmp/tempjarfile_log4j_${dt}.txt"


if [ -n "${1}" ]; then
        script_home="${1}"
else
        script_home=`pwd`
fi


filescan () {
find ${1} -type f -name "*.jar" -exec echo "{}" \; >>${tempfile_jar}

while IFS= read -r line; do
            findclass=`${2} ${3} "${line}" |grep -i JndiLookup.class`
            if [ -n "${findclass}" ]; then
                    echo -e "${GREEN}++++++++++++below file searched which might be posibility of vulnerable log4j file++++++++${NONE}\n"
                    echo -e "${GREEN}file found:- ${findclass} ${NONE}\n"
                    echo -e "${GREEN}inside jar:- ${line} ${NONE}\n"
                    echo -e "${GREEN}++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++${NONE}\n"
                    echo -e "\n\n"
            fi
            findlog4jcore=`echo "${findclass}" | egrep -i "log4j|core"`
            if [ -n "${findlog4jcore}" ]; then
                    echo "vulnerable log4j file:- ${line} and it has class inside:- ${findclass}" >>"${tempfile}"
                    echo -e "\n" >>"${tempfile}"
            fi
done < ${tempfile_jar}


if [ -f "${tempfile}" ]; then
        tempfileread=`cat ${tempfile}`
        echo -e "${RED}##################below is the vulnerable log4j file which needs to be fixed############################${NONE}\n"
        echo -e "${RED} ${tempfileread} ${NONE}"
        echo -e "${RED}########################################################################################################${NONE}\n"
        rm "${tempfile}"
		rm "${tempfile_jar}"
fi
}

##finding jar/unzip in the system to scan the files
findjar=`command -v jar`
findjartest="$?"
findunzip=`command -v unzip`
findunziptest="$?"

if [ "${findjartest}" = 0 ]; then 
filescan  ${script_home} jar tvf
elif [ "${findunziptest}" = 0 ]; then
filescan  ${script_home} unzip -xv
else 
echo -e "Command jar/unzip not found in this machine to scan the jar files. \n"; 
fi